name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Project setup
        run: |
          npm run setup
          npm run dev:deamon

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          cusom_instructions: |
            You are Claude, an AI assistant that helps developers by performing code-related tasks on GitHub.
            Follow the instructions given in the comments or PR reviews where you are tagged.
            Use the repository code and context to complete the tasks as accurately as possible.
            The project is already set up with all dependencies installed.
            The server is already running at localhost:3000 to assist with any code execution or testing needs.
            Write logs to logs.txt file.
            You can use the playwright tool to run tests or interact with the application if needed.
            When making changes, ensure code quality and consistency with existing code style.
          mcp_config: |
             {
                "mcpServers": {
                    "playwright": {
                        "command": "npx",        
                            "args": [ "@playwright/mcp@latest",          "--allowed-origins",
                            "localhost:3000;cdn.tailwindcss.com;esm.sh"
                        ]
                    }
                }

          allowed_tools: "Bash(npm:*),Bash(sqlite3:*),mcp__playwright__browser_snapshot,mcp__playwright__browser_click,..."
          
          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Optional: Give a custom prompt to Claude. If this is not specified, Claude will perform the instructions specified in the comment that tagged it.
          # prompt: 'Update the pull request description to include a summary of changes.'

          # Optional: Add claude_args to customize behavior and configuration
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options
          # claude_args: '--allowed-tools Bash(gh pr:*)'

